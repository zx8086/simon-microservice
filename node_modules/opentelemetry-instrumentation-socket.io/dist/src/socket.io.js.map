{"version":3,"file":"socket.io.js","sourceRoot":"","sources":["../../src/socket.io.ts"],"names":[],"mappings":"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","sourcesContent":["import { context, trace, Span, SpanKind, SpanStatusCode, diag } from '@opentelemetry/api';\nimport {\n    InstrumentationBase,\n    InstrumentationNodeModuleFile,\n    InstrumentationNodeModuleDefinition,\n    isWrapped,\n    safeExecuteInTheMiddle,\n} from '@opentelemetry/instrumentation';\nimport {\n    SemanticAttributes,\n    MessagingOperationValues,\n    MessagingDestinationKindValues,\n} from '@opentelemetry/semantic-conventions';\nimport type { HttpInstrumentationConfig } from '@opentelemetry/instrumentation-http';\nimport { SocketIoInstrumentationConfig, Io, SocketIoInstrumentationAttributes, defaultSocketIoPath } from './types';\nimport { VERSION } from './version';\nimport isPromise from 'is-promise';\n\nconst reservedEvents = ['connect', 'connect_error', 'disconnect', 'disconnecting', 'newListener', 'removeListener'];\n\nexport class SocketIoInstrumentation extends InstrumentationBase<Io> {\n    protected override _config!: SocketIoInstrumentationConfig;\n\n    constructor(config: SocketIoInstrumentationConfig = {}) {\n        super('opentelemetry-instrumentation-socket.io', VERSION, normalizeConfig(config));\n        if (config.filterHttpTransport) {\n            const httpInstrumentationConfig =\n                config.filterHttpTransport.httpInstrumentation.getConfig() as HttpInstrumentationConfig;\n            if (!Array.isArray(httpInstrumentationConfig.ignoreIncomingPaths)) {\n                httpInstrumentationConfig.ignoreIncomingPaths = [];\n            }\n            httpInstrumentationConfig.ignoreIncomingPaths.push(\n                config.filterHttpTransport.socketPath ?? defaultSocketIoPath\n            );\n            config.filterHttpTransport.httpInstrumentation.setConfig(httpInstrumentationConfig);\n        }\n    }\n\n    protected init() {\n        const socketInstrumentation = new InstrumentationNodeModuleFile<any>(\n            'socket.io/dist/socket.js',\n            ['>=3'],\n            (moduleExports, moduleVersion) => {\n                if (moduleExports === undefined || moduleExports === null) {\n                    return moduleExports;\n                }\n                diag.debug(`socket.io instrumentation: applying patch to socket.io@${moduleVersion} Socket`);\n                if (isWrapped(moduleExports?.Socket?.prototype?.on)) {\n                    this._unwrap(moduleExports.Socket.prototype, 'on');\n                }\n                this._wrap(moduleExports.Socket.prototype, 'on', this._patchOn(moduleVersion));\n                if (isWrapped(moduleExports?.Socket?.prototype?.emit)) {\n                    this._unwrap(moduleExports.Socket.prototype, 'emit');\n                }\n                this._wrap(moduleExports.Socket.prototype, 'emit', this._patchEmit(moduleVersion));\n                return moduleExports;\n            },\n            (moduleExports) => {\n                if (isWrapped(moduleExports?.Socket?.prototype?.on)) {\n                    this._unwrap(moduleExports.Socket.prototype, 'on');\n                }\n                if (isWrapped(moduleExports?.Socket?.prototype?.emit)) {\n                    this._unwrap(moduleExports.Socket.prototype, 'emit');\n                }\n                return moduleExports;\n            }\n        );\n\n        const broadcastOperatorInstrumentation = new InstrumentationNodeModuleFile<any>(\n            'socket.io/dist/broadcast-operator.js',\n            ['>=4'],\n            (moduleExports, moduleVersion) => {\n                if (moduleExports === undefined || moduleExports === null) {\n                    return moduleExports;\n                }\n                diag.debug(\n                    `socket.io instrumentation: applying patch to socket.io@${moduleVersion} StrictEventEmitter`\n                );\n                if (isWrapped(moduleExports?.BroadcastOperator?.prototype?.emit)) {\n                    this._unwrap(moduleExports.BroadcastOperator.prototype, 'emit');\n                }\n                this._wrap(moduleExports.BroadcastOperator.prototype, 'emit', this._patchEmit(moduleVersion));\n                return moduleExports;\n            },\n            (moduleExports) => {\n                if (isWrapped(moduleExports?.BroadcastOperator?.prototype?.emit)) {\n                    this._unwrap(moduleExports.BroadcastOperator.prototype, 'emit');\n                }\n                return moduleExports;\n            }\n        );\n        const namespaceInstrumentation = new InstrumentationNodeModuleFile<any>(\n            'socket.io/dist/namespace.js',\n            ['<4'],\n            (moduleExports, moduleVersion) => {\n                if (moduleExports === undefined || moduleExports === null) {\n                    return moduleExports;\n                }\n                diag.debug(`socket.io instrumentation: applying patch to socket.io@${moduleVersion} Namespace`);\n                if (isWrapped(moduleExports?.Namespace?.prototype?.emit)) {\n                    this._unwrap(moduleExports.Namespace.prototype, 'emit');\n                }\n                this._wrap(moduleExports.Namespace.prototype, 'emit', this._patchEmit(moduleVersion));\n                return moduleExports;\n            },\n            (moduleExports) => {\n                if (isWrapped(moduleExports?.Namespace?.prototype?.emit)) {\n                    this._unwrap(moduleExports.Namespace.prototype, 'emit');\n                }\n            }\n        );\n        const socketInstrumentationLegacy = new InstrumentationNodeModuleFile<any>(\n            'socket.io/lib/socket.js',\n            ['2'],\n            (moduleExports, moduleVersion) => {\n                if (moduleExports === undefined || moduleExports === null) {\n                    return moduleExports;\n                }\n                diag.debug(`socket.io instrumentation: applying patch to socket.io@${moduleVersion} Socket`);\n                if (isWrapped(moduleExports.prototype?.on)) {\n                    this._unwrap(moduleExports.prototype, 'on');\n                }\n                this._wrap(moduleExports.prototype, 'on', this._patchOn(moduleVersion));\n                if (isWrapped(moduleExports.prototype?.emit)) {\n                    this._unwrap(moduleExports.prototype, 'emit');\n                }\n                this._wrap(moduleExports.prototype, 'emit', this._patchEmit(moduleVersion));\n                return moduleExports;\n            },\n            (moduleExports) => {\n                if (isWrapped(moduleExports.prototype?.on)) {\n                    this._unwrap(moduleExports.prototype, 'on');\n                }\n                if (isWrapped(moduleExports.prototype?.emit)) {\n                    this._unwrap(moduleExports.prototype, 'emit');\n                }\n                return moduleExports;\n            }\n        );\n        const namespaceInstrumentationLegacy = new InstrumentationNodeModuleFile<any>(\n            'socket.io/lib/namespace.js',\n            ['2'],\n            (moduleExports, moduleVersion) => {\n                if (moduleExports === undefined || moduleExports === null) {\n                    return moduleExports;\n                }\n                diag.debug(`socket.io instrumentation: applying patch to socket.io@${moduleVersion} Namespace`);\n                if (isWrapped(moduleExports?.prototype?.emit)) {\n                    this._unwrap(moduleExports.prototype, 'emit');\n                }\n                this._wrap(moduleExports.prototype, 'emit', this._patchEmit(moduleVersion));\n                return moduleExports;\n            },\n            (moduleExports) => {\n                if (isWrapped(moduleExports?.prototype?.emit)) {\n                    this._unwrap(moduleExports.prototype, 'emit');\n                }\n            }\n        );\n\n        return [\n            new InstrumentationNodeModuleDefinition<Io>(\n                'socket.io',\n                ['>=3'],\n                (moduleExports, moduleVersion) => {\n                    if (moduleExports === undefined || moduleExports === null) {\n                        return moduleExports;\n                    }\n                    diag.debug(`socket.io instrumentation: applying patch to socket.io@${moduleVersion} Server`);\n                    if (isWrapped(moduleExports?.Server?.prototype?.on)) {\n                        this._unwrap(moduleExports.Server.prototype, 'on');\n                    }\n                    this._wrap(moduleExports.Server.prototype, 'on', this._patchOn(moduleVersion));\n                    return moduleExports;\n                },\n                (moduleExports, moduleVersion) => {\n                    if (isWrapped(moduleExports?.Server?.prototype?.on)) {\n                        this._unwrap(moduleExports.Server.prototype, 'on');\n                    }\n                    return moduleExports;\n                },\n                [broadcastOperatorInstrumentation, namespaceInstrumentation, socketInstrumentation]\n            ),\n            new InstrumentationNodeModuleDefinition<any>(\n                'socket.io',\n                ['2'],\n                (moduleExports, moduleVersion) => {\n                    if (moduleExports === undefined || moduleExports === null) {\n                        return moduleExports;\n                    }\n                    diag.debug(`socket.io instrumentation: applying patch to socket.io@${moduleVersion} Server`);\n                    if (isWrapped(moduleExports?.prototype?.on)) {\n                        this._unwrap(moduleExports.prototype, 'on');\n                    }\n                    this._wrap(moduleExports.prototype, 'on', this._patchOn(moduleVersion));\n                    return moduleExports;\n                },\n                (moduleExports, moduleVersion) => {\n                    if (isWrapped(moduleExports?.prototype?.on)) {\n                        this._unwrap(moduleExports.prototype, 'on');\n                    }\n                    return moduleExports;\n                },\n                [namespaceInstrumentationLegacy, socketInstrumentationLegacy]\n            ),\n        ];\n    }\n\n    override setConfig(config: SocketIoInstrumentationConfig = {}) {\n        return super.setConfig(normalizeConfig(config));\n    }\n\n    private _patchOn(moduleVersion: string) {\n        const self = this;\n        return (original: Function) => {\n            return function (ev: any, originalListener: Function) {\n                if (!self._config.traceReserved && reservedEvents.includes(ev)) {\n                    return original.apply(this, arguments);\n                }\n                if (self._config.onIgnoreEventList.includes(ev)) {\n                    return original.apply(this, arguments);\n                }\n                const wrappedListener = function (...args: any[]) {\n                    const eventName = ev;\n                    const defaultNamespace = '/';\n                    const namespace = this.name || this.adapter?.nsp?.name;\n                    const destination = namespace === defaultNamespace ? eventName : `${namespace} ${eventName}`;\n                    const span: Span = self.tracer.startSpan(`${destination} ${MessagingOperationValues.RECEIVE}`, {\n                        kind: SpanKind.CONSUMER,\n                        attributes: {\n                            [SemanticAttributes.MESSAGING_SYSTEM]: 'socket.io',\n                            [SemanticAttributes.MESSAGING_DESTINATION]: namespace,\n                            [SemanticAttributes.MESSAGING_OPERATION]: MessagingOperationValues.RECEIVE,\n                            [SocketIoInstrumentationAttributes.SOCKET_IO_EVENT_NAME]: eventName,\n                        },\n                    });\n\n                    if (self._config.onHook) {\n                        safeExecuteInTheMiddle(\n                            () => self._config.onHook(span, { moduleVersion, payload: args }),\n                            (e) => {\n                                if (e) diag.error(`socket.io instrumentation: onHook error`, e);\n                            },\n                            true\n                        );\n                    }\n                    return context.with(trace.setSpan(context.active(), span), () =>\n                        self.endSpan(() => originalListener.apply(this, arguments), span)\n                    );\n                };\n                return original.apply(this, [ev, wrappedListener]);\n            };\n        };\n    }\n\n    private endSpan(traced: () => any | Promise<any>, span: Span) {\n        try {\n            const result = traced();\n            if (isPromise(result)) {\n                return Promise.resolve(result)\n                    .catch((err) => {\n                        if (err) {\n                            if (typeof err === 'string') {\n                                span.setStatus({ code: SpanStatusCode.ERROR, message: err });\n                            } else {\n                                span.recordException(err);\n                                span.setStatus({ code: SpanStatusCode.ERROR, message: err?.message });\n                            }\n                        }\n                        throw err;\n                    })\n                    .finally(() => span.end());\n            } else {\n                span.end();\n                return result;\n            }\n        } catch (error: any) {\n            span.recordException(error);\n            span.setStatus({ code: SpanStatusCode.ERROR, message: error?.message });\n            span.end();\n            throw error;\n        }\n    }\n\n    private _patchEmit(moduleVersion: string) {\n        const self = this;\n        return (original: Function) => {\n            return function (ev: any, ...args: any[]) {\n                if (!self._config.traceReserved && reservedEvents.includes(ev)) {\n                    return original.apply(this, arguments);\n                }\n                if (self._config.emitIgnoreEventList.includes(ev)) {\n                    return original.apply(this, arguments);\n                }\n                const messagingSystem = 'socket.io';\n                const eventName = ev;\n                const attributes: any = {\n                    [SemanticAttributes.MESSAGING_SYSTEM]: messagingSystem,\n                    [SemanticAttributes.MESSAGING_DESTINATION_KIND]: MessagingDestinationKindValues.TOPIC,\n                    [SocketIoInstrumentationAttributes.SOCKET_IO_EVENT_NAME]: eventName,\n                };\n\n                let rooms = this.rooms || this._rooms || this.sockets?._rooms || this.sockets?.rooms || [];\n                // Some of the attributes above are of Set type. Convert it.\n                if (!Array.isArray(rooms)) {\n                    rooms = Array.from<string>(rooms);\n                }\n                // only for v2: this.id is only set for v2. That's to mimic later versions which have this.id in the rooms Set.\n                if (rooms.length === 0 && this.id) {\n                    rooms.push(this.id);\n                }\n                if (rooms.length) {\n                    attributes[SocketIoInstrumentationAttributes.SOCKET_IO_ROOMS] = rooms;\n                }\n                const namespace = this.name || this.adapter?.nsp?.name || this.sockets?.name;\n                if (namespace) {\n                    attributes[SocketIoInstrumentationAttributes.SOCKET_IO_NAMESPACE] = namespace;\n                    attributes[SemanticAttributes.MESSAGING_DESTINATION] = namespace;\n                }\n                const spanRooms = rooms.length ? `[${rooms.join()}]` : '';\n                const span = self.tracer.startSpan(`${namespace}${spanRooms} send`, {\n                    kind: SpanKind.PRODUCER,\n                    attributes,\n                });\n\n                if (self._config.emitHook) {\n                    safeExecuteInTheMiddle(\n                        () => self._config.emitHook(span, { moduleVersion, payload: args }),\n                        (e) => {\n                            if (e) diag.error(`socket.io instrumentation: emitHook error`, e);\n                        },\n                        true\n                    );\n                }\n                try {\n                    return context.with(trace.setSpan(context.active(), span), () => original.apply(this, arguments));\n                } catch (error) {\n                    span.setStatus({ code: SpanStatusCode.ERROR, message: error.message });\n                    throw error;\n                } finally {\n                    span.end();\n                }\n            };\n        };\n    }\n}\n\nconst normalizeConfig = (config?: SocketIoInstrumentationConfig) => {\n    config = Object.assign({}, config);\n    if (!Array.isArray(config.emitIgnoreEventList)) {\n        config.emitIgnoreEventList = [];\n    }\n    if (!Array.isArray(config.onIgnoreEventList)) {\n        config.onIgnoreEventList = [];\n    }\n    return config;\n};\n"]}